apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: kueue-system

resources:
- ./dev
- ../../../../config/dev

transformers:
- patches/rolebinding_transformer.yaml

patches:
- path: patches/secret-deletion.yaml
  target:
    kind: Secret
    name: kueue-webhook-server-cert
    namespace: kueue-system
- path: image_pull_policy.yaml
  target:
    kind: Deployment
    name: controller-manager
    namespace: kueue-system
- path: cainjection-templates/cainjection_in_clusterqueues.yaml
- path: cainjection-templates/cainjection_in_localqueues.yaml
- path: cainjection-templates/cainjection_in_workloads.yaml
- path: cainjection-templates/cainjection_in_resourceflavors.yaml
- path: cainjection-templates/cainjection_in_cohorts.yaml
- path: cainjection-templates/apiservice_cainjection_patch.yaml
  target:
    kind: APIService
    name: v1beta1.visibility.kueue.x-k8s.io
- path: cainjection-templates/apiservice_cainjection_patch.yaml
  target:
    kind: APIService
    name: v1beta2.visibility.kueue.x-k8s.io    
- path: cainjection-templates/mutating_webhookcainjection_patch.yaml
- path: cainjection-templates/validating_webhookcainjection_patch.yaml


configMapGenerator:
- behavior: merge
  files:
  - controller_manager_config.yaml
  name: kueue-manager-config
  namespace: kueue-system

replacements:
  # 1. Replace $(METRICS_SERVICE_NAME)
  - source:
      kind: Service
      name: controller-manager-metrics-service
      version: v1
      fieldPath: metadata.name
    targets:
      - select:
          kind: Certificate
          name: metrics-cert
        fieldPaths:
          - spec.dnsNames.0
          - spec.dnsNames.1
        options:
          delimiter: "."
          index: 0
      - select: 
          kind: ServiceMonitor
          name: controller-manager-metrics-monitor
          version: v1
        fieldPaths:
          - spec.endpoints.0.tlsConfig.serverName
        options:
          delimiter: "."
          index: 0      

  # 2. Replace METRICS_SERVICE_NAMESPACE 
  - source:
      kind: Service
      name: controller-manager-metrics-service
      version: v1
      fieldPath: metadata.namespace
    targets:
      - select:
          kind: Certificate
          name: metrics-cert
        fieldPaths:
          - spec.dnsNames.0
          - spec.dnsNames.1
        options:
          delimiter: "."
          index: 1
      - select: 
          kind: ServiceMonitor
          name: controller-manager-metrics-monitor
          version: v1
        fieldPaths:
          - spec.endpoints.0.tlsConfig.serverName
        options:
          delimiter: "."
          index: 1      


  # 3. Replace $(SERVICE_NAME)
  - source:
      kind: Service
      name: webhook-service
      version: v1
      fieldPath: metadata.name
    targets:
      - select:
          kind: Certificate
          name: serving-cert
        fieldPaths:
          - spec.dnsNames.0
          - spec.dnsNames.1
        options:
          delimiter: "."
          index: 0              


  # 4. Replace $(SERVICE_NAMESPACE)
  - source:
      kind: Service
      name: webhook-service
      version: v1
      fieldPath: metadata.namespace
    targets:
      - select:
          kind: Certificate
          name: serving-cert
        fieldPaths:
          - spec.dnsNames.0
          - spec.dnsNames.1
        options:
          delimiter: "."
          index: 1 

  #5.  Replace $(CERTIFICATE_NAME)  
  - source:
      kind: Certificate
      name: serving-cert
      version: v1
      fieldPath: metadata.name
    targets:
      - select:
          kind: CustomResourceDefinition
          name: clusterqueues.kueue.x-k8s.io
        fieldPaths:
          - metadata.annotations.[cert-manager.io/inject-ca-from]
        options:
          delimiter: "/"
          index: 1
      - select:
          kind: CustomResourceDefinition
          name: localqueues.kueue.x-k8s.io
        fieldPaths:
          - metadata.annotations.[cert-manager.io/inject-ca-from]
        options:
          delimiter: "/"
          index: 1
      - select:
          kind: CustomResourceDefinition
          name: resourceflavors.kueue.x-k8s.io
        fieldPaths:
          - metadata.annotations.[cert-manager.io/inject-ca-from]
        options:
          delimiter: "/"
          index: 1
      - select:
          kind: CustomResourceDefinition
          name: workloads.kueue.x-k8s.io
        fieldPaths:
          - metadata.annotations.[cert-manager.io/inject-ca-from]
        options:
          delimiter: "/"
          index: 1
      - select:
          kind: MutatingWebhookConfiguration
          name: mutating-webhook-configuration
        fieldPaths:
          - metadata.annotations.[cert-manager.io/inject-ca-from]
        options:
          delimiter: "/"
          index: 1
      - select:
          kind: ValidatingWebhookConfiguration
          name: validating-webhook-configuration
        fieldPaths:
          - metadata.annotations.[cert-manager.io/inject-ca-from]
        options:
          delimiter: "/"
          index: 1

  #6.  Replace $(CERTIFICATE_NAMESPACE)  
  - source:
      kind: Certificate
      name: serving-cert
      version: v1
      fieldPath: metadata.namespace
    targets:
      - select:
          kind: CustomResourceDefinition
          name: clusterqueues.kueue.x-k8s.io
        fieldPaths:
          - metadata.annotations.[cert-manager.io/inject-ca-from]
        options:
          delimiter: "/"
          index: 0
      - select:
          kind: CustomResourceDefinition
          name: localqueues.kueue.x-k8s.io
        fieldPaths:
          - metadata.annotations.[cert-manager.io/inject-ca-from]
        options:
          delimiter: "/"
          index: 0
      - select:
          kind: CustomResourceDefinition
          name: resourceflavors.kueue.x-k8s.io
        fieldPaths:
          - metadata.annotations.[cert-manager.io/inject-ca-from]
        options:
          delimiter: "/"
          index: 0
      - select:
          kind: CustomResourceDefinition
          name: workloads.kueue.x-k8s.io
        fieldPaths:
          - metadata.annotations.[cert-manager.io/inject-ca-from]
        options:
          delimiter: "/"
          index: 0
      - select:
          kind: MutatingWebhookConfiguration
          name: mutating-webhook-configuration
        fieldPaths:
          - metadata.annotations.[cert-manager.io/inject-ca-from]
        options:
          delimiter: "/"
          index: 0
      - select:
          kind: ValidatingWebhookConfiguration
          name: validating-webhook-configuration
        fieldPaths:
          - metadata.annotations.[cert-manager.io/inject-ca-from]
        options:
          delimiter: "/"
          index: 0

  #7. Replace $(VISIBILITY_SERVICE_NAME)
  - source:
      kind: Service
      name: visibility-server
      version: v1
      fieldPath: metadata.name
    targets:
      - select:
          kind: Certificate
          name: visibility-server-cert
        fieldPaths:
          - spec.dnsNames.0
          - spec.dnsNames.1
        options:
          delimiter: "."
          index: 0

  #8. Replace $(VISIBILITY_SERVICE_NAMESPACE)
  - source:
      kind: Service
      name: visibility-server
      version: v1
      fieldPath: metadata.namespace
    targets:
      - select:
          kind: Certificate
          name: visibility-server-cert
        fieldPaths:
          - spec.dnsNames.0
          - spec.dnsNames.1
        options:
          delimiter: "."
          index: 1

  #9. Replace $(VISIBILITY_CERTIFICATE_NAME)
  - source:
      group: cert-manager.io
      kind: Certificate
      name: visibility-server-cert
      version: v1
      fieldPath: metadata.name
    targets:
      - select:
          kind: APIService
          name: v1beta1.visibility.kueue.x-k8s.io
        fieldPaths:
          - metadata.annotations.[cert-manager.io/inject-ca-from]
        options:
          delimiter: "/"
          index: 1
      - select:
          kind: APIService
          name: v1beta2.visibility.kueue.x-k8s.io
        fieldPaths:
          - metadata.annotations.[cert-manager.io/inject-ca-from]
        options:
          delimiter: "/"
          index: 1    


  #10. Replace $(VISIBILITY_CERTIFICATE_NAMESPACE)
  - source:
      group: cert-manager.io
      kind: Certificate
      name: visibility-server-cert
      version: v1
      fieldPath: metadata.namespace
    targets:
      - select:
          kind: APIService
          name: v1beta1.visibility.kueue.x-k8s.io
        fieldPaths:
          - metadata.annotations.[cert-manager.io/inject-ca-from]
        options:
          delimiter: "/"
          index: 0
      - select:
          kind: APIService
          name: v1beta2.visibility.kueue.x-k8s.io
        fieldPaths:
          - metadata.annotations.[cert-manager.io/inject-ca-from]
        options:
          delimiter: "/"
          index: 0            
